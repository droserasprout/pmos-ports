# Reference: <https://postmarketos.org/vendorkernel>
# Kernel config based on: arch/arm64/configs/raphael_defconfig

pkgname=linux-xiaomi-raphael
pkgver=4.14.320
pkgrel=0
pkgdesc="Xiaomi 9T Pro kernel fork"
arch="aarch64"
_carch="arm64"
_flavor="xiaomi-raphael"
url="https://kernel.org"
license="GPL-2.0-only"
options="!strip !check !tracedeps pmb:cross-native"
makedepends="
	bash
	bc
	bison
	devicepkg-dev
	findutils
	flex
	linux-headers
	openssl-dev
	perl
	clang
	llvm
	lld
	xz
	python3
"

# Source
# 
# _org="PixelExperience-Devices"
# _repository="kernel_xiaomi_raphael"
# _commit="ddb4ef010e177f4b33e54a0214da214a530fa2ef"

# _org="xiaomi-sm8150-devs"
# _repository="android_kernel_xiaomi_sm8150"
# _commit="ddb4ef010e177f4b33e54a0214da214a530fa2ef"

# _repository="android_kernel_xiaomi_sm8150-legacy"
# _commit="343ff33bf560de8a6f2debdf1d3b23e27fd364e3"

# _repository="sm8150-mainline"
# _commit="4870a82ab62ee793d9332ebf9d5d83995a2f365e"

_org="crdroidandroid"
_repository="android_kernel_xiaomi_sm8150"
_commit="c4bf3c16786ae0901d540a4011f4fdc1c1239a79"

_config="config-$_flavor.$arch"
source="
	$pkgname-$_commit.tar.gz::https://github.com/$_org/$_repository/archive/$_commit.tar.gz
	$_config
"
builddir="$srcdir/$_repository-$_commit"
_outdir="out"

CC="clang"
HOSTCC="clang"
LD="ld.lld"

prepare() {
	default_prepare
	REPLACE_GCCH=0 . downstreamkernel_prepare
}

build() {
	unset LDFLAGS
	make O="$_outdir" ARCH="$_carch" CC="${CC:-gcc}" \
		KBUILD_BUILD_VERSION="$((pkgrel + 1 ))-postmarketOS"
}

package() {
	downstreamkernel_package "$builddir" "$pkgdir" "$_carch" \
		"$_flavor" "$_outdir"
}

sha512sums="
899100f14f8c2412d0125a6c9f0f76052965acbe8abe0f40a8727f3cd9b56c1b7fa8aacef1492e4e35e83692ce3b41b82014b1858e09387e513414921ede1529  linux-xiaomi-raphael-c4bf3c16786ae0901d540a4011f4fdc1c1239a79.tar.gz
9772cb9f13469ab2165ab7360a1c1145eb8511400200eb054eba460a176f4eb4893e8af7bac3bedd4b40b949ee7ac8a088ab306a30dafabfd5194e7138d62d2e  config-xiaomi-raphael.aarch64
"
